<!doctype html>
<html>
<head>
	<title>OTP test</title>

	<meta charset="utf-8"/>
	<script src="js/lib/jquery-1.8.3.min.js"></script>
	<script src="cordova.js"></script>
	<script src="js/system.js"></script>
	<script src="js/geocode.js"></script>
	<script src="js/otp.js"></script>
	<script src="js/ui.js"></script>
	
	<link href="css/ui-lightness/jquery-ui-1.10.3.custom.css" rel="stylesheet">
	<script src="js/lib/jquery-ui-1.10.3.custom.min.js"></script>
</head>
<body>
	<div id="header">	<span id="left">| <span id="back">&lt;</span> | <span id="fav">&hearts;</span> |</span>  
						<span id="center">Frits</span> 
						<span id="right">| O | <span id="vraagteken">?</span> |</span></div>
	
	<div id="mapDiv" style="width: 100%; height: 600px; margin-top: 3em;">
		<p>.</p>
	</div>
	
	<script src="js/init.js"></script>
	<script src="js/lib/jquery.json-2.4.min.js"></script>
	<script src="OpenLayers/OpenLayers.js"></script>
	<script type="text/javascript">
	
		/**
		 * Coordinate System Projections, for ease of use
		 */
		var geometric = new OpenLayers.Projection("EPSG:4326");
		var mercator = new OpenLayers.Projection("EPSG:900913");
		
		/**
		 * Definition of the Style of a drawn Line 
		 */
		var lineStyle = {
			style: {
				strokeColor: "#ff0000",
				strokeWidth: 5
			}
		};
		
		/**
		 * Definitions for the Icon to be used by Markers 
		 */
		var size = new OpenLayers.Size(21,25);
		var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
		var markerIcon = new OpenLayers.Icon('http://www.openlayers.org/dev/img/marker.png', size, offset);
		
		/**
		 * Creates a new Map object, with an OpenLayers Map, a new OSM Layer,
		 * and objects representing the used Projection.
		 * 
		 * @constructor
		 * @this {Map}
		 * @param {String} id The id of the HTML div element in which the map will be put
		 */
		function Map(id)
		{
			this.map = new OpenLayers.Map(id);
			this.layer = new OpenLayers.Layer.OSM();
			this.map.addLayer(this.layer);
			this.proj = {};
			this.proj.from = geometric;
			this.proj.to = this.map.getProjection();
		}
		
		/**
		 * Gets the Route Data and Leg Nr. from local storage and extracts the current Leg
		 * 
		 * @returns {String} the legGeometry of the Leg
		 */
		function getLegGeometry() {
			var i = localStorage['ShowMap'];
			var string = localStorage['OTP data'];
			
			var data = $.evalJSON(string);
			
			return data.itineraries[0].legs[i].legGeometry.points;
		}
		
		/**
		 * Converts the given geometry string to a Feature Vector, which can immediately be
		 * imported in the Vector Layer of a Map
		 * 
		 * @param {String} geometry The legGeometry of the Leg
		 * @returns {[OpenLayers.Feature.Vector]} an array of Feature Vectors  
		 */
		function getFeatures(geometry) {
			var format = new OpenLayers.Format.EncodedPolyline();
			
			var features = format.read(geometry);
			
			if(features.constructor != Array) {
				features = [features];
			}
			
			return features;
		}
		
		/**
		 * The initialization function of the page, which gets the leg info and geometry,
		 * creates a map and displays the leg on the map, after which it zooms to an appropriate
		 * level and pans to the appropriate location.
		 */
		$(function()
			{
				var geometry = getLegGeometry();
				
				var features = getFeatures(geometry);
				
				var map = new Map("mapDiv");
				var vectorLayer = new OpenLayers.Layer.Vector("Vector Layer", lineStyle);
				var markerLayer = new OpenLayers.Layer.Markers("Marker Layer");
				
				map.map.addLayers([vectorLayer, markerLayer]);
				
				var bounds;
				
				// Convert the Features points to coordinates used by the Map
				$.each(features, function(i, e){
					e = e.geometry.transform(geometric, map.proj.to);
					
					//Expand the current bounds to include the feature
					if(!bounds) {
						bounds = e.getBounds();
					} else {
						bounds.extend(e.getBounds());
					}
				});
				
				// Add the Features to the Map
				vectorLayer.addFeatures(features);
				
				// Get the First and Last points of the Leg
				var points = features[0].geometry.components;
				var point1 = points[0];
				var point2 = points[points.length-1];
				
				// Add the points as Markers
				markerLayer.addMarker(new OpenLayers.Marker(
					new OpenLayers.LonLat(point1.x, point1.y), 
					markerIcon.clone())
				);
				markerLayer.addMarker(new OpenLayers.Marker(
					new OpenLayers.LonLat(point2.x, point2.y), 
					markerIcon.clone())
				);
				
				// Zoom to exactly show the leg
				map.map.zoomToExtent(bounds);
			}
		);
	</script>
</body>
</html>