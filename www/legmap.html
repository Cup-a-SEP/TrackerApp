<!doctype html>
<html>
<head>
	<title>OTP test</title>

	<meta charset="utf-8"/>
	<script src="js/lib/jquery-1.8.3.min.js"></script>
	<script src="cordova.js"></script>
	<script src="js/system.js"></script>
	<script src="js/geocode.js"></script>
	<script src="js/otp.js"></script>
	<script src="js/ui.js"></script>
	
	<link href="css/ui-lightness/jquery-ui-1.10.3.custom.css" rel="stylesheet">
	<script src="js/lib/jquery-ui-1.10.3.custom.min.js"></script>
</head>
<body>
	<div id="header">	<span id="left">| <span id="back">&lt;</span> | <span id="fav">&hearts;</span> |</span>  
						<span id="center">Frits</span> 
						<span id="right">| O | <span id="vraagteken">?</span> |</span></div>
	
	<div id="mapDiv" style="width: 100%; height: 600px; margin-top: 3em;">
		<p>.</p>
	</div>
	
	<script src="js/init.js"></script>
	<script src="js/lib/jquery.json-2.4.min.js"></script>
	<script src="OpenLayers/OpenLayers.js"></script>
	<script type="text/javascript">
		var geometric = new OpenLayers.Projection("EPSG:4326");
		var mercator = new OpenLayers.Projection("EPSG:900913");
		var map;
		
		var lineStyle = {
			style: {
				strokeColor: "#ff0000",
				strokeWidth: 5
			}
		};
		
		var size = new OpenLayers.Size(21,25);
		var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
		var markerIcon = new OpenLayers.Icon('http://www.openlayers.org/dev/img/marker.png', size, offset);
		
		/**
		 * Creates a new Map object, with an OpenLayers Map, a new OSM Layer,
		 * and objects representing the used Projection.
		 */
		function Map(id)
		{
			this.map = new OpenLayers.Map(id);
			this.layer = new OpenLayers.Layer.OSM();
			this.map.addLayer(this.layer);
			this.proj = {};
			this.proj.from = geometric;
			this.proj.to = this.map.getProjection();
		}
		
		$(function()
			{
				// Get the Leg Nr. and the Plan Data
				var i = localStorage['ShowMap'];
				var string = localStorage['OTP data'];
				
				// Convert the Plan Data to a JS Object
				var data = $.evalJSON(string);
				
				// Get the legGeometry
				var geometry = data.itineraries[0].legs[i].legGeometry.points;
				
				map = new Map("mapDiv");
				
				// Create a converter for the legGeometry to Feature(s)
				var format = new OpenLayers.Format.EncodedPolyline();
				
				// Read the Feature(s) from the legGeometry
				var features = format.read(geometry);
				
				// Convert to an Array of Features if not already
				if(features.constructor != Array) {
					features = [features];
				}
				
				var bounds;
				
				// Create Layers for the Markers and Lines
				var vectorLayer = new OpenLayers.Layer.Vector("Vector Layer", lineStyle);
				var markerLayer = new OpenLayers.Layer.Markers("Marker Layer");
				
				// Add the Layers to the Map
				map.map.addLayers([vectorLayer, markerLayer]);
				
				// Convert the Features points to coordinates used by the Map
				$.each(features, function(i, e){
					e = e.geometry.transform(geometric, map.proj.to);
					
					//Expand the current bounds to include the feature
					if(!bounds) {
						bounds = e.getBounds();
					} else {
						bounds.extend(e.getBounds());
					}
				});
				
				// Add the Features to the Map
				vectorLayer.addFeatures(features);
				
				// Get the First and Last points of the Leg
				var points = features[0].geometry.components;
				var point1 = points[0];
				var point2 = points[points.length-1];
				
				// Add the points as Markers
				markerLayer.addMarker(new OpenLayers.Marker(
					new OpenLayers.LonLat(point1.x, point1.y), 
					markerIcon.clone())
				);
				markerLayer.addMarker(new OpenLayers.Marker(
					new OpenLayers.LonLat(point2.x, point2.y), 
					markerIcon.clone())
				);
				
				// Zoom to exactly show the leg
				map.map.zoomToExtent(bounds);
			}
		);
	</script>
</body>
</html>