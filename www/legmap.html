<!doctype html>
<html>
<head>
	<title>OTP test</title>

	<meta charset="utf-8"/>
	<script src="js/lib/jquery-1.8.3.min.js"></script>
	<script src="cordova.js"></script>
	<script src="js/system.js"></script>
	<script src="js/geocode.js"></script>
	<script src="js/otp.js"></script>
	<script src="js/ui.js"></script>
	
	<link href="css/ui-lightness/jquery-ui-1.10.3.custom.css" rel="stylesheet">
	<script src="js/lib/jquery-ui-1.10.3.custom.min.js"></script>
</head>
<body>
	<div id="header">	<span id="left">| <span id="back">&lt;</span> | <span id="fav">&hearts;</span> |</span>  
						<span id="center">Frits</span> 
						<span id="right">| O | <span id="vraagteken">?</span> |</span></div>
	
	<div id="mapDiv" style="width: 100%; height: 600px; margin-top: 3em;">
		<p>.</p>
	</div>
	
	<script src="js/init.js"></script>
	<script src="js/lib/jquery.json-2.4.min.js"></script>
	<script src="OpenLayers/OpenLayers.js"></script>
	<script type="text/javascript">
		var geometric = new OpenLayers.Projection("EPSG:4326");
		var mercator = new OpenLayers.Projection("EPSG:900913");
		var map;
		function Map(id)
		{
			this.map = new OpenLayers.Map(id);
			this.proj = {};
			this.proj.from = geometric;
			this.proj.to = mercator;
			this.layer = new OpenLayers.Layer.OSM();
			this.map.addLayer(this.layer);
			this.move(51.4474477,5.4873561);
		}
		
		Map.prototype.move = function(lat, lng)
			{
				this.map.setCenter(new OpenLayers.LonLat(lng,lat).transform(this.proj.from, this.proj.to), 18);
			};
		
		$(function()
			{
				var i = localStorage['ShowMap'];
				var string = localStorage['OTP data'];
				
				var data = $.evalJSON(string);
				
				var leg = data.itineraries[0].legs[i];
				
				var geometry = leg.legGeometry.points;
				
				map = new Map("mapDiv");
				
				var format = new OpenLayers.Format.EncodedPolyline();
				
				var points = format.read(geometry);
				
				var bounds;
				
				var vectorLayer = new OpenLayers.Layer.Vector("Vector Layer");
				var markerLayer = new OpenLayers.Layer.Markers("Marker Layer");
				
				map.map.addLayers([markerLayer, vectorLayer]);
				
				// Convert the points from Geometric to Mercator coordinates:
				// Convert the Feature to an Array of Points
				var pointArray = points.geometry.components;
				var pointArray2 = new Array();
				
				// Calculate the Mercator coordinates for each point and put it in a new Point, and append it to the Array
				$.each(pointArray, function(i, e){
					var ll = new OpenLayers.LonLat(e.x, e.y).transform(geometric, mercator);
					
					pointArray2.push(new OpenLayers.Geometry.Point(ll.lon, ll.lat));
				});
				
				// Create a new Feature of the Mercator Points
				var feature = new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(pointArray2));
				
				vectorLayer.addFeatures([feature]);
				markerLayer.addMarker(new OpenLayers.Marker(new OpenLayers.LonLat(pointArray2[0].x, pointArray2[0].y)));
				markerLayer.addMarker(new OpenLayers.Marker(new OpenLayers.LonLat(pointArray2[pointArray2.length-1].x, pointArray2[pointArray2.length-1].y)));
				
				bounds = feature.geometry.getBounds();
				map.map.zoomToExtent(bounds);
			}
		);
	</script>
</body>
</html>