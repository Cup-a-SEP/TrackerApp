<!doctype html>
<html>
<head>
	<title>OTP test</title>

	<meta charset="utf-8"/>
	<script src="js/lib/prototype-1.7.1.js"></script>
	<script src="js/lib/jquery-1.8.3.min.js"></script>
	<script src="js/lib/jquery.json-2.4.min.js"></script>
	<script src="cordova.js"></script>
	<script src="js/misc.js"></script>
	<script src="js/system.js"></script>
	<script src="js/class/localdb.class.js"></script>
	<script src="js/storage.js"></script>
	<script src="js/geocode.js"></script>
	<script src="js/otp.js"></script>
	<script src="js/service.js"></script>
	<script src="js/ui.js"></script>
	
	<link href="css/ui-lightness/jquery-ui-1.10.3.custom.css" rel="stylesheet">
	<script src="js/lib/jquery-ui-1.10.3.custom.min.js"></script>
</head>
<body>
	<div id="header">
		<span id="left"><span id="back">&lt;</span></span>  
		<span id="center">Frits</span> 
		<span id="right"><span id="vraagteken">?</span></span>
	</div>
	<div id="itineraryHeader" style="margin-top: 3.2em">
	</div>
	<section id="plan">
	</section>
	<div id="planbutton">Track deze route</div>
	<script src="js/init.js"></script>
	<script>
		
		$(function()
		{
			// Initialize database
			Storage.Trips.init();
			var req = $.evalJSON(localStorage['OTP request']);
			var data = $.evalJSON(localStorage['OTP data pending']);
			
			var from = data.from.name;
			var to = data.to.name;
			var start = UI.formatTime(data.itineraries[0].startTime);
			var end = UI.formatTime(data.itineraries[0].endTime);
			
			$('#itineraryHeader').empty().append($('<h3>')
					.text(start + ' ' + from + ' - ' + end + ' ' + to))
				.click(function()
				{
					clickMap(-1);
				});
			
			var route;
			$('#plan').empty().append(route = $('<div>').attr('id', 'route'));
			
			route.add = UI.addItinerary;
			route.add(data.itineraries[0]);
			route.accordion({collapsible:true});
			
			var legLength = data.itineraries[0].legs.length;
			for(var i = 0; i < legLength; ++i)
			{
				$('#legmap' + i).click(function()
				{
					clickMap(this.id.substring(6));
				});
			}
			
			$('#planbutton').click(function(){
				localStorage['OTP data'] = localStorage['OTP data pending'];
				var it = data.itineraries[0];
				req.expectedDepartureTime = it.legs[0].startTime;
				req.expectedArrivalTime = it.legs[it.legs.length-1].endTime;
				Storage.Trips.store(req).always(function()
				{
					window.location = "currenttrip.html";
				});
			});
		});
		
		function clickMap(i)
		{
			localStorage['ShowMap'] = i;
			window.location = "legmap.html";
		}
	</script>
</body>
</html>