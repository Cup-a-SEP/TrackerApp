<!DOCTYPE html>
<html>

<head>
	<title>Frits</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no"><!-- makes clicks 300ms faster, no joke -->

	<link href="css/ui-lightness/jquery-ui-1.10.3.custom.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/index.css" />
	
	<style type="text/css">
		section {
			width: 100%;
		}
		
		input {
			width: 75%;
			float: right;
		}
		button, select {
			float: right;
		}
		.time {
			float:right;
		}
		
		#sugto, #sugfrom {
			display: none;
		}
		
		div.datetimeholder {
			width:80%;
			float:right;
		}
		
		div.datetimeholder input#date,
		div.datetimeholder input#time {
			width:100%;
		}
	</style>
</head>
<body>
	<div id="header"><span id="left"><span id="back">&lt;</span></span>  
	<span id="center">Frits</span> 

	<span id="right"><span id="vraagteken">?</span></span></div>
	
	<section>
	<div class="headerbuffer">
		<h4 id="headertekst">AJAX-enabled page</h4>

		<a id="planknopmetsupervetteajax" class="divbutton"><p class="button">Plan je route</p></a>
	</div>
	</section>
	
	<script src="js/lib/prototype-1.7.1.js"></script>
	<script src="js/lib/jquery-1.8.3.min.js"></script>
	<script src="js/lib/jquery.json-2.4.min.js"></script>
	<script src="cordova.js"></script>
	<script src="js/misc.js"></script>
	<script src="js/system.js"></script>
	<script src="js/class/localdb.class.js"></script>
	<script src="js/storage.js"></script>
	<script src="js/geocode.js"></script>
	<script src="js/otp.js"></script>
	<script src="js/ui.js"></script>
	<script src="js/lib/jquery-ui-1.10.3.custom.min.js"></script>
	<script type="text/javascript" src="js/index_ajax.js"></script>
	
	<script type="text/javascript">
		app.initialize();
		
		document.addEventListener("deviceready", onDeviceReady, false);
		
		function onDeviceReady()
		{
			console.log("Test Device ready");
			document.addEventListener("backbutton", onBackButton, false);
			Storage.init();
			startWatch();
		}
		
		function onBackButton()
		{
			console.log('The user wants to close the app.');
			navigator.app.exitApp();
		}
		
		$(function()
		{
			document.addEventListener("backbutton", onBackButton, false);
		});
	</script>
	<script src="js/init.js"></script>
	<script>
		// Modality button states
		var modalities =
		{
			walk: true,
			bus: true,
			rail: true,
			tram: true,
			subway: true,
			ferry: true
		};
		
		$(function()
		{
			// Initialize database
			Storage.Locations.init();
			
			// Initialize to/from input boxes
			var sugfrom = new UI.Suggestion($('#sugfrom'), $('#from'), 5, true, function(coords, address)
			{
				$('#from').val(address);
				$('#fromPlace').val(coords);
			});
			var sugto = new UI.Suggestion($('#sugto'), $('#to'), 5, false, function(coords, address)
			{
				$('#to').val(address);
				$('#toPlace').val(coords);
			});
			
			$('#from').keyup(function() { $('#fromPlace').val(''); });
			$('#to').keyup(function() { $('#toPlace').val(''); });
			
			// Initialize suggestions list
			sugfrom.list = sugto.list = {};
			Storage.Locations.list(Infinity).done(function(res)
			{
				$.each(res, function(i, item)
				{
					sugto.list[item.name] = item.latlng;
				});
			});
			/*{
				'Eindhoven': '51.44302,5.479576',
				'Utrecht': '52.089398,5.109861',
				'Tilburg': '51.55972,5.087558',
				'Groningen': '53.210766,6.564099',
				'Breda': '51.595067,4.780053',
			};*/
			
			// Initialize date/time input boxes
			$('#date').datepicker()/*val(System.getDate())*/;
			$('#time').timepicker({'step': 1})/*val(System.getTime())*/;
			
			// Initialize modality buttons
			$.each(modalities, function(name)
			{
				var mod = $('#' + name);
				mod.click(function()
				{
					modalities[name] = !modalities[name];
					mod.css('opacity', modalities[name] ? 1 : .3);
					$('#mode').val($.map(modalities, function(value, name)
					{
						if (value)
							return name.toUpperCase();
					}).join(','));
				});
			});
			
			// Send request to planner
			$('#plan').click(function(event)
			{
				event.preventDefault();
				
				var req = {};
				$.each($('#form').serializeArray(), function(i, item)
				{
					req[item.name] = item.value;
				});
				
				$('#status').empty().append($('<h1>').text("Zoeken..."));
				
				// Save locations
				if (req.fromPlace)
					Storage.Locations.store(req.from, req.fromPlace, false);
				if (req.toPlace)
					Storage.Locations.store(req.to, req.toPlace, false);
				
				OTP.plan(req).done(function(data)
				{
					var stripped = (function(ser)
					{
						return ser;
					})(data);
					
					// Save planner data
					localStorage['OTP request'] = $.toJSON(req);
					localStorage['OTP data'] = $.toJSON(data);
					
					window.location = "OTPresult.html";
				}).fail(function(error, message)
				{
					$('#status').empty()
						.append($('<h1>').text('Sorry! De OV-gids van Frits is kapot! :('))
						.append($('<h3>').text(message));
				});
				
				return false;
			});
		});
	</script>
</body>
</html>
