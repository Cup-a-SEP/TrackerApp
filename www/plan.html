<!doctype html>
<html>
<head>
	<title>OTP test</title>

	<meta charset="utf-8"/>
	<script src="js/lib/jquery-1.8.3.min.js"></script>
	<script src="cordova.js"></script>
	<script src="js/system.js"></script>
	<script src="js/geocode.js"></script>
	<script src="js/otp.js"></script>
	<script src="js/ui.js"></script>
	
	<link href="css/ui-lightness/jquery-ui-1.10.3.custom.css" rel="stylesheet">
	<script src="js/lib/jquery-ui-1.10.3.custom.min.js"></script>
	<style type="text/css">
		section {
			width: 100%;
		}
		
		input {
			width: 75%;
			float: right;
		}
		button, select {
			float: right;
		}
		.time {
			float:right;
		}
	</style>
</head>
<body>
	<div id="header">	<span id="left">| <span id="back">&lt;</span> | <span id="fav">&hearts;</span> |</span>  
						<span id="center">Frits</span> 
						<span id="right">| <span id="vraagteken">?</span> |</span></div>
	<section>
		<form class="headerbuffer">
			<div class="licht" id="fromdiv">
				<label>Van: <input type="text" id="from"></label>
				<input type="hidden" name="fromPlace"><p>
			</div>
			<div class="donker" id="todiv">
				<label>Naar: <input type="text" id="to"></label>
				<input type="hidden" name="toPlace"><p>
			</div>
			<div class="licht">
				<label>Plan: <select name="arriveBy">
					<option value="false">vertrek</option>
					<option value="true">aankomst</option>
				</select></label>
			</div>
			<div class="donker">
				<label>Date: <input type="date" name="date"></label>
			</div>
			<div class="licht">
				<label>Time: <input type="time" name="time"></label>
			</div>
			<div class="donker">
				<label>Voorkeur: <select name="preferLeastTransfers">
					<option value="false">snelste route</option>
					<option value="true">minst aantal overstappen</option>
				</select></label>
			</div>
			<div class="licht">
				<label>Modaliteiten:</label> 
				<div align="center">
					<img src="img/bus.png" class="icon" id="bus">
					<img src="img/rail.png" class="icon" id="trein">
					<img src="img/tram.png" class="icon" id="tram">
					<img src="img/subway.png" class="icon" id="metro">
					<img src="img/ferry.png" class="icon" id="veerpont">
				</div>
			</div>
			<div class="donker">
				<label>Rolstoel: <input type="checkbox" name="wheelchair" value="true"></label>
			</div>
			<input type="submit" value="Plan" id="submitButton">
		</form>
	</section>
	<section id="plan">
		
	</section>
	<script src="js/init.js"></script>
	<script src="js/lib/jquery.json-2.4.min.js"></script>
	<script>
		

		/**
		 * index 0: bus
		 * index 1: trein
		 * index 2: tram
		 * index 3: metro
		 * index 4: veerpont 
		 */
		var modalities = new Array();
		var modality_names = ["BUS", "RAIL", "TRAM", "SUBWAY", "FERRY"];
		var permanentStorage = window.localStorage;
		var tempStorage = window.sessionStorage;
		
		var favorites = ["Eindhoven", "Eindhoven station", "Eindhoven TUe", "Meppel", "Maaskantje", "Enkhuizen"]; // dummy 'database', used for the suggestions. Sorted: the first item should be the one most used
		var prevused = ["Maaskantje friettent", "Maaskantje bowling", "Eindhoven PSV stadion", "Madurodam"]; // dummy 'database', used for the suggestions. Sorted: the first item should be the one most used
		var curLocation = "";
		var totalPositions = 5; // maximum amount of suggestions shown per location
		
		function initModalities(){
			
			for(var i = 0; i < 5; i++){
				modalities[i] = true;
			}
			
			var bus = $('#bus');
			bus.click(function(event){
				if (modalities[0]) {
					bus.css({opacity:0.30});
					modalities[0] = false;
				} else {
					bus.css({opacity:1});
					modalities[0] = true;
				}
			});
			
			var trein = $('#trein');
			trein.click(function(event){
				if (modalities[1]) {
					trein.css({opacity:0.30});
					modalities[1] = false;
				} else {
					trein.css({opacity:1});
					modalities[1] = true;
				}
			});
			
			var tram = $('#tram');
			tram.click(function(event){
				if (modalities[2]) {
					tram.css({opacity:0.30});
					modalities[2] = false;
				} else {
					tram.css({opacity:1});
					modalities[2] = true;
				}
			});
			
			var metro = $('#metro');
			metro.click(function(event){
				if (modalities[3]) {				
					metro.css({opacity:0.30});
					modalities[3] = false;
				} else {
					metro.css({opacity:1});
					modalities[3] = true;
				}
			});
			
			var veerpont = $('#veerpont');
			veerpont.click(function(event){
				if (modalities[4]) {
					veerpont.css({opacity:0.30});
					modalities[4] = false;
				} else {
					veerpont.css({opacity:1});
					modalities[4] = true;
				}
			});
		}

		$(function()
		{	
			
			$("input[name='date']").val(System.getDate());
			$("input[name='time']").val(System.getTime());
			
			initModalities();
			initLocationChoosers();
			
			var from = $('#from');
			
			from.click(function(){
				// show the suggestions
				updateSuggestions('from');
			});
			from.keypress(function(event)
			{
				// wait one millisecond; this way, $('#from').val() will be up to date
				setTimeout(function(){updateSuggestions('from');},1);
			});
			
			var to = $('#to');
			var sessionTo = tempStorage.getItem("to");
			if(sessionTo != null){
				to.val(sessionTo);
				setTimeout(function()
				{
					Geo.code(to.val()).done(function(coords, name)
					{
						$("input[name='toPlace']").val(coords);
					});
				}, 0);
			}
			to.click(function(){
				// show the suggestions
				updateSuggestions('to');
			});
			to.keypress(function(event)
			{
				// wait one millisecond; this way, $('#to').val() will be up to date
				setTimeout(function(){updateSuggestions('to');},1);
			});
			
			var form = $('form');
			var plan = $('#plan');
			
			form.submit(function()
			{
				var req = {};
				$.each(form.serializeArray(), function(i, obj)
				{
					req[obj.name] = obj.value;
				});
				
				req[mode] = $.map(modalities, function(x,i)
				{
					if (x)
						return modality_names[i];
				}).join(',');
				
				$('#submitButton').remove();
				plan.empty().append($('<h1>').text("Loading..."));
				
				OTP.plan(req).done(function(data)
				{
					var stripped = (function(ser) {
						return ser;
					})(data);
					
					var serialized = $.toJSON(data);
					
					localStorage['OTP data'] = serialized;
					
					window.location = "OTPresult.html";
					/*
					 * console.log(data);
					 * var route;
					 * plan.empty().append(route = $('<div>').attr('id', 'route'));
					 * route.add = UI.addItinerary;
					 * route.add(data.itineraries[0]);
					 * route.accordion({collapsible:true});
					 */
				}).fail(function(error, message)
				{
					plan.empty()
						.append($('<h1>').text('Sorry! De OV-gids van Frits is kapot! :('))
						.append($('<h3>').text(message));
				});
				
				return false;
			});
		});
		
		// gives the Lebenstein distance from s to t with the given delete, insert and substitution costs
		function LsteinDistance(s, t, delCost, insCost, subsCost)
		{
			// use Dynamic Programming, d[i][j] = the cost from s.substring(i) to t.substring(j)
			var d = new Array(s.length + 1);
			for(var i = 0; i < d.length; i++){
				d[i] = new Array(t.length + 1);
			}
			d[0][0] = 0;
			for (var i = 1; i <= s.length; i++){
				d[i][0] = i*delCost;
			}
			for(var i = 1; i <= t.length; i++){
				d[0][i] = i*insCost;
			}
			for(var j = 1; j <= t.length; j++){
				for(var i = 1; i <= s.length; i++){
					if(s.charAt(i-1) == t.charAt(j-1)){
						d[i][j] = d[i-1][j-1];
					} else {
						d[i][j] = Math.min(d[i-1][j] + delCost, Math.min(d[i][j-1]+insCost, d[i-1][j-1] + subsCost));
					}
				}
			}
			return d[s.length][t.length];
		}
		
		// initialize the location choosers
		function initLocationChoosers(){
			// all suggestions have the following form:
			// id: suggestion + to/from + idNumber
			
			// each div around the 
			// location numbers:
			// 0: Google geocode
			// 1 -> totalPositions: favorites
			// totalPositions + 1 -> 2*totalPositions: previously used
			// 2*totalPositions + 1: current location
			for(var i = 0; i <= 2*totalPositions; i++){
				addSuggestion('fromdiv', 'suggestionfrom', i, 'testingText' + i, 'from');
				addSuggestion('todiv', 'suggestionto', i, 'testingText' + i, 'to');
			}
			addSuggestion('fromdiv', 'suggestionfrom', 2*totalPositions+1, 'Huidige locatie', 'from');
			
			System.getLocation().done(function(coords)
			{
				Geo.decode(coords).done(function(coords, name)
				{
					var from = $('#from');
					if(from.val() == ""){
						from.val(name);
						$("input[name='fromPlace']").val(coords);
						$('#fromName').text("Huidige locatie");
					}
					curLocation = name;
				});
			});
		}
		
		function addSuggestion(location, idName, idNumber, text, toChange){
			var id = idName+idNumber;
			$('#' + location).append($('<div>').attr('id',id).text(""));
			var elem = $('#' + id);
			elem.append($('<h1>').text(text));
			elem.click(function(e){
				$('#' + toChange).val(text);
				for(var i = 0; i <= 2*totalPositions+1; i++){
					$('#' + idName + i).hide();
				}
			});
			elem.hide();
		}
		
		function changeSuggestion(idName, idNumber, text, toChange){
			var id = idName+idNumber;
			var elem = $('#' + id);
			elem.empty();
			elem.append($('<h1>').text(text));
			elem.click(function(e){
				$('#' + toChange).val(text);
				for(var i = 0; i <= 2*totalPositions+1; i++){
					$('#' + idName + i).hide();
				}
			});
		}
		
		function setVisibleSuggestion(id, vis){
			var elem = $('#' + id);
			if(vis){
				elem.show();
			} else {
				elem.hide();
			}
		}
		
		function updateSuggestions(location){
			var maxTolerance = 3;
			var delCost = 2;
			var insCost = 0;
			var subsCost = 1;
			
			var filled = 1;
			var curTyped = $('#' + location).val();
			
			//current location already up to date (assuming user does not move)
			
			//google location
			setTimeout(function()
			{
				Geo.code(curTyped).done(function(coords, name)
				{
					$("input[name='" + location + "']").val(coords);
					changeSuggestion('suggestion'+ location, 0, name, location);
					setVisibleSuggestion('suggestion'+ location + '0',true);
				}).fail(function(code,message){
					setVisibleSuggestion('suggestion'+ location + '0',false);
				});
			}, 0);
			
			//favorites
			var LsteinDistances = new Array();
			var minDist = 1000;
			for(var i = 0; i < favorites.length; i++){
				LsteinDistances[i] = LsteinDistance(curTyped, favorites[i], delCost, insCost, subsCost);
				if(minDist > LsteinDistances[i]){
					minDist = LsteinDistances[i];
				}
			}
			
			while(filled < totalPositions && minDist <= maxTolerance){
				for(var i = 0; i < favorites.length; i++){
					if(LsteinDistances[i] == minDist && filled < totalPositions){
						changeSuggestion("suggestion"+location,filled,favorites[i],location);
						setVisibleSuggestion("suggestion"+location+filled,true);
						filled ++;
					}
				}
				minDist ++;
				if(filled == favorites.length){
					break;
				}
			}
			for(var i = filled; i <= totalPositions; i++){
				setVisibleSuggestion("suggestion"+location+i,false);
			}
			
			//previously used
			var prevUsedFilled = 0;
			
			LsteinDistances = new Array();
			minDist = 1000;
			for(var i = 0; i < prevused.length; i++){
				LsteinDistances[i] = LsteinDistance(curTyped, prevused[i], delCost, insCost, subsCost);
				if(minDist > LsteinDistances[i]){
					minDist = LsteinDistances[i];
				}
			}
			
			while(filled < totalPositions && minDist <= maxTolerance){
				for(var i = 0; i < prevused.length; i++){
					if(LsteinDistances[i] == minDist && filled < totalPositions){
						changeSuggestion("suggestion"+location,prevUsedFilled+totalPositions,prevused[i],location);
						setVisibleSuggestion("suggestion"+location+(prevUsedFilled+totalPositions),true);
						filled ++;
						prevUsedFilled ++;
					}
				}
				minDist ++;
				if(filled == prevused.length){
					break;
				}
			}
			for(var i = prevUsedFilled+1; i <= totalPositions; i++){
				setVisibleSuggestion("suggestion"+location+(i+totalPositions),false);
			}
			
			//GPS
			if(location == 'from' && curLocation != ""){
				setVisibleSuggestion("suggestionfrom" + (totalPositions*2+1),true);
			}
		}
	</script>
</body>
</html>