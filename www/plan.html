<!doctype html>
<html>
<head>
	<title>OTP test</title>

	<meta charset="utf-8"/>
	<script src="js/lib/prototype-1.7.1.js"></script>
	<script src="js/lib/jquery-1.8.3.min.js"></script>
	<script src="js/lib/jquery.json-2.4.min.js"></script>
	<script src="cordova.js"></script>
	<script src="js/misc.js"></script>
	<script src="js/system.js"></script>
	<script src="js/class/localdb.class.js"></script>
	<script src="js/storage.js"></script>
	<script src="js/geocode.js"></script>
	<script src="js/otp.js"></script>
	<script src="js/ui.js"></script>
	
	<link href="css/ui-lightness/jquery-ui-1.10.3.custom.css" rel="stylesheet">
	<script src="js/lib/jquery-ui-1.10.3.custom.min.js"></script>
	<style type="text/css">
		section {
			width: 100%;
		}
		
		input {
			width: 75%;
			float: right;
		}
		button, select {
			float: right;
		}
		.time {
			float:right;
		}
		
		#sugto, #sugfrom {
			display: none;
		}
	</style>
</head>
<body>
	<div id="header">
		<span id="left"><span id="back">&lt;</span></span>
		<span id="center">Frits</span> 
		<span id="right"><span id="vraagteken">?</span></span>
	</div>
	<section>
		<div class="headerbuffer">
			
			<div class="eiland" class="shadow">
			
			<div class="divborder" id="fromdiv">
				<label>Van<input type="text" id="from" placeholder="..."></label>
			</div>
			<div id="sugfrom" class="suggestionsdiv"></div>
			
			<div class="divborder" id="todiv">
				<label>Naar<input type="text" id="to" placeholder="..."></label>
			</div>
			<div id="sugto" class="suggestionsdiv"></div>
			
			<div class="divborder" id="datetime">
				<div id="ditmoetopdezelfdelijn">
					<select name="arriveBy" id="arriveBy">
						<option value="false">vertrek</option>
						<option value="true">aankomst</option>
					</select>
					<input type="date" name="date" id="date">
					<input type="time" name="time" id="time">
				</div>
			</div>	
				
			<div class="divborder" id="voorkeur">
				<label>Voorkeur<select name="preferLeastTransfers" id="preferenceDropdown">
					<option value="false">snelste route</option>
					<option value="true">minst aantal overstappen</option>
				</select></label>
			</div>
			
			<div class="divborder" id="modaliteiten">
				<label>Modaliteiten<div align="center">
					<img src="img/bus.png" class="icon" id="bus">
					<img src="img/rail.png" class="icon" id="rail">
					<img src="img/tram.png" class="icon" id="tram">
					<img src="img/subway.png" class="icon" id="subway">
					<img src="img/ferry.png" class="icon" id="ferry">
				</div></label>
			</div>
			
			<div class="divborder" id="wheelchairdiv">
				<label>Rolstoel <input type="checkbox" name="wheelchair" value="true"></label>
			</div>
			
			<div id="planknop">
				<span id="fav">&hearts;</span>
				<button id="plan">Plan</button>
			</div>
			
			</div><!-- einde eiland -->
			
		</div>
	</section>
	<section id="status">
	</section>
	<script src="js/init.js"></script>
	<script>
		// Modality button states
		var modalities =
		{
			bus: true,
			rail: true,
			tram: true,
			subway: true,
			ferry: true
		};
		
		// Coordinates of places
		var fromPlace = '';
		var toPlace = '';
		
		$(function()
		{
			// Initialize to/from input boxes
			var sugfrom = new UI.Suggestion($('#sugfrom'), $('#from'), 5, true, function(coords, address)
			{
				$('#from').val(address);
				fromPlace = coords;
			});
			var sugto = new UI.Suggestion($('#sugto'), $('#to'), 5, false, function(coords, address)
			{
				$('#to').val(address);
				toPlace = coords;
			});
			
			// Debug
			sugfrom.list = sugto.list =
			{
				'Eindhoven': '51.44302,5.479576',
				'Utrecht': '52.089398,5.109861',
				'Tilburg': '51.55972,5.087558',
				'Groningen': '53.210766,6.564099',
				'Breda': '51.595067,4.780053',
			};
			
			// Initialize date/time input boxes
			$('#date').val(System.getDate());
			$('#time').val(System.getTime());
			
			// Initialize modality buttons
			$.each(modalities, function(name)
			{
				var mod = $('#' + name);
				mod.click(function()
				{
					modalities[name] = !modalities[name];
					mod.css('opacity', modalities[name] ? 1 : .3);
				});
			});
			
			// Send request to planner
			$('#plan').click(function()
			{
				var req =
				{
					fromPlace: fromPlace,
					toPlace: toPlace,
					time: $('#time').val(),
					date: $('#date').val(),
					arriveBy: $('#arriveBy').val(),
					preferLeastTransfers: $('#preferenceDropdown').val(),
					wheelchair: $('#wheelchair').is(':checked'),
					mode: $.map(modalities, function(value, name)
					{
						if (value)
							return name.toUpperCase();
					}).join(',')
				};
				console.log(req);
				
				$('#status').empty().append($('<h1>').text("Zoeken..."));
				
				OTP.plan(req).done(function(data)
				{
					var stripped = (function(ser)
					{
						return ser;
					})(data);
					
					localStorage['OTP data'] = $.toJSON(data);
					
					window.location = "OTPresult.html";
				}).fail(function(error, message)
				{
					$('#status').empty()
						.append($('<h1>').text('Sorry! De OV-gids van Frits is kapot! :('))
						.append($('<h3>').text(message));
				});
				
				return false;
			});
		});
	</script>
</body>
</html>