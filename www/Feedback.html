<!doctype html>
<html>
	<head>
		<title>Feedback form</title>
		<meta charset="utf-8"/>
		<script src="js/lib/prototype-1.7.1.js"></script>
		<script src="js/lib/jquery-1.8.3.min.js"></script>
		<script src="js/lib/jquery.json-2.4.min.js"></script>
		<script src="cordova.js"></script>
		<script src="js/system.js"></script>
		<script src="js/class/localdb.class.js"></script>
		<script src="js/storage.js"></script>
		<script src="js/geocode.js"></script>
		<script src="js/otp.js"></script>
		<script src="js/ui.js"></script>

		<link href="css/ui-lightness/jquery-ui-1.10.3.custom.css" rel="stylesheet">
		<script src="js/lib/jquery-ui-1.10.3.custom.min.js"></script>
	</head>
	<body>
		<div id="header">
			<span id="left"><span id="back">&lt;</span></span>
			<span id="center">Frits</span>
			<span id="right"><span id="vraagteken">?</span></span>
		</div>
		<form class="headerbuffer" id="form">
			<div class="eilandLight" class="shadow">
				<select name="ComplaintSubject" id="subject" onchange="changeForm()" class="feedbackelement">
					<option value="frits">Frits</option>
					<option value="route">Route</option>
					<option value="ovvoorziening">Voorziening</option>
				</select>
				<select name="legSelect" id="legs" style="display:none" class="feedbackelement">
					<option>Selecteer een voorziening</option>
				</select>
				<br>
				<div id="itineraryHeader" style="display:none"></div>
				<textarea id="comment" cols="14" rows="15" class="feedbackelement">Licht hier uw klacht toe</textarea>
				<br>
				<button type="button" onclick="buttonClick()" class="feedbackelement" id="submitButton">
					Verstuur klacht
				</button>
			</div>
		</form>

		<script src="js/init.js"></script>
		<script>
			// function createJson() {
			// var data = $.evalJSON(localStorage['OTP data']);
			// var package = new Object();
			// package.date = data.date;
			// document.getElementById("comment").value += data.date+"   Je Moeder   ";
			// package.from = {"lon" : data.from.lon, "lat":data.from.lat};
			// package.to = {"lon" : data.to.lon, "lat":data.to.lat};
			// package.itineraries = [{"startTime":data.itineraries[0].startTime,"endTime":data.itineraries[0].startTime}];
			// document.getElementById("comment").value += package.itineraries[0];
			// for(var i =0; i<data.itineraries[0].legs.length; i++){
			// package.itineraries[0].legs[i].startTime=data.itineraries[0].legs[i].startTime;
			// package.itineraries[0].legs[i].endTime=data.itineraries[0].legs[i].endTime;
			// package.itineraries[0].legs[i].mode=data.itineraries[0].legs[i].mode;
			// package.itineraries[0].legs[i].route=data.itineraries[0].legs[i].route;
			// package.itineraries[0].legs[i].from.stopId=data.itineraries[0].legs[i].from.stopId;
			// package.itineraries[0].legs[i].to.stopId=data.itineraries[0].legs[i].to.stopId;
			// package.itineraries[0].legs[i].tripId=data.itineraries[0].legs[i].tripId;
			// }
			// var myString = JSON.stringify(package);
			// return myString;
			// }

			/**
			 * Handles the sending of the feedback
			 */
			function buttonClick() {
				var index = document.getElementById("subject").selectedIndex;

				if (index == 0) {
					var link = "mailto:sjarlie.graaumans@gmail.com" + "&subject=" + escape("Klacht over Frits") + "&body=" + escape(document.getElementById('comment').value);

					window.location.href = link;

					document.getElementById("comment").value = "Email verzonden!";
					document.getElementById("submitButton").disabled = true;
				} else if (index == 1) {
					var link = "mailto:sjarlie.graaumans@gmail.com" + "&subject=" + escape("Klacht over de route") + "&body=" + escape(document.getElementById('comment').value + "\nREQUEST:  " + localStorage['OTP request']);

					window.location.href = link;

					document.getElementById("comment").value = "Email verzonden!";
					document.getElementById("submitButton").disabled = true;
				} else if (document.getElementById("legs").selectedIndex==0){
					
					document.getElementById("comment").value = "Selecteer een voorziening in het tweede drop-down menu!";
				}else{
					var e = document.getElementById("legs");
					var link = "mailto:sjarlie.graaumans@gmail.com" + "&subject=" + escape("Klacht over ") + e.options[e.selectedIndex].text + "&body=" + escape(document.getElementById('comment').value);

					window.location.href = link;
					document.getElementById("comment").value = "Email verzonden!";
					document.getElementById("submitButton").disabled = true;
				}
			}

			/**
			 * Makes the legs dropdown menu visible and fills it with the different parts of a journey a user can have a complaint about
			 */
			function getLegs() {
				$('#legs').attr("style", "display : block");
				var data = $.evalJSON(localStorage['OTP data']);
				var first = true;
				for (var i = 0; i < data.itineraries[0].legs.length; i++) {
					if (data.itineraries[0].legs[i].mode == "BUS") {
						if (first) {
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].from.name + '>' + data.itineraries[0].legs[i].from.name + '</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].tripId + '>Bus - ' + data.itineraries[0].legs[i].route + '</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].to.name + '>' + data.itineraries[0].legs[i].to.name + '</option>');
							first = false;
						} else {
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].tripId + '>Bus - ' + data.itineraries[0].legs[i].route + '</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].to.name + '>' + data.itineraries[0].legs[i].to.name + '</option>');
						}
					} else if (data.itineraries[0].legs[i].mode == "RAIL") {
						if (first) {
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].from.name + '>' + data.itineraries[0].legs[i].from.name + ', Station NS</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].tripId + '>' + data.itineraries[0].legs[i].routeShortName + ' - ' + data.itineraries[0].legs[i].routeLongName + '</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].to.name + '>' + data.itineraries[0].legs[i].to.name + ', Station NS</option>');
							first = false;
						} else {
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].tripId + '>' + data.itineraries[0].legs[i].routeShortName + ' - ' + data.itineraries[0].legs[i].routeLongName + '</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].to.name + '>' + data.itineraries[0].legs[i].to.name + ', Station NS</option>');
						}
					} else if (data.itineraries[0].legs[i].mode == "TRAM") {
						if (first) {
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].from.name + '> Tramhalte - ' + data.itineraries[0].legs[i].from.name + '</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].tripId + '> Tram ' + data.itineraries[0].legs[i].routeShortName + ' - ' + data.itineraries[0].legs[i].routeLongName + '</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].to.name + '> Tramhalte - ' + data.itineraries[0].legs[i].to.name + '</option>');
							first = false;
						} else {
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].tripId + '> Tram ' + data.itineraries[0].legs[i].routeShortName + ' - ' + data.itineraries[0].legs[i].routeLongName + '</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].to.name + '> Tramhalte - ' + data.itineraries[0].legs[i].to.name + '</option>');
						}
					} else if (data.itineraries[0].legs[i].mode == "SUBWAY") {
						if (first) {
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].from.name + '> Metrohalte - ' + data.itineraries[0].legs[i].from.name + '</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].tripId + '> Metro ' + data.itineraries[0].legs[i].routeShortName + ' - ' + data.itineraries[0].legs[i].routeLongName + '</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].to.name + '> Metrohalte - ' + data.itineraries[0].legs[i].to.name + '</option>');
							first = false;
						} else {
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].tripId + '> Metro ' + data.itineraries[0].legs[i].routeShortName + ' - ' + data.itineraries[0].legs[i].routeLongName + '</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].to.name + '> Metrohalte - ' + data.itineraries[0].legs[i].to.name + '</option>');
						}
					} else if (data.itineraries[0].legs[i].mode == "FERRY") {
						if (first) {
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].from.name + '> Veerponthalte - ' + data.itineraries[0].legs[i].from.name + '</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].tripId + '> Veerpont ' + data.itineraries[0].legs[i].routeShortName + ' - ' + data.itineraries[0].legs[i].routeLongName + '</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].to.name + '> Veerponthalte - ' + data.itineraries[0].legs[i].to.name + '</option>');
							first = false;
						} else {
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].tripId + '> Veerpont ' + data.itineraries[0].legs[i].routeShortName + ' - ' + data.itineraries[0].legs[i].routeLongName + '</option>');
							$("#legs").append('<option value=' + data.itineraries[0].legs[i].to.name + '> Veerponthalte - ' + data.itineraries[0].legs[i].to.name + '</option>');
						}
					}

				}
			}
			/**
			 * Makes a div visible that shows the user about which route he is making a complaint.
			 */
			function createDiv() {
				$('#itineraryHeader').attr("style", "display : block");
				$('#itineraryHeader').attr("style", "margin-top: 3.2 em");
				var req = $.evalJSON(localStorage['OTP request']);
				var data = $.evalJSON(localStorage['OTP data']);

				var from = data.from.name;
				var to = data.to.name;
				var start = UI.formatTime(data.itineraries[0].startTime);
				var end = UI.formatTime(data.itineraries[0].endTime);
				$('#itineraryHeader').append($('<h3>').text(start + ' ' + from + ' - ' + end + ' ' + to));
			}
			/**
			 * Empties the div and makes it invisible.
			 */
			function emptyDiv() {
				$('#itineraryHeader').empty();
				$('#itineraryHeader').attr("style", "display : none");
				$('#itineraryHeader').attr("style", "margin-top: 0 em");
				$('#itineraryHeader').attr("style", "border: 0px");
			}
			/**
			 * Changes the form of the layout according to which type of complaint the user has.
			 */
			function changeForm() {
				var index = document.getElementById("subject").selectedIndex;
				if (index == 0) {
					document.getElementById("comment").value = "Licht hier uw klacht toe";
					emptyDiv();
					$('#legs').attr("style", "display : none");
				} else if (index == 1) {
					$('#legs').attr("style", "display : none");
					if (localStorage['OTP request'] == null) {
						document.getElementById("comment").value = "Plan een route voor je gaat klagen, zeikerd";
					} else {
						document.getElementById("comment").value = "Licht hier uw klacht toe";
						createDiv();
					}

				} else {
					emptyDiv();
					getLegs();
					if (localStorage['OTP request'] == null) {
						document.getElementById("comment").value = "Plan een route voor je gaat klagen, zeikerd";
					} else {
						document.getElementById("comment").value = "Licht hier uw klacht toe";
					}
				}
			}

			$(function() {
				// Initialize database
				Storage.Trips.init();
			});
			/**
			 * Empties the textfield when it is tapped.
			 */
			$("#comment").focus(function() {

				if ($(this).val() == "Licht hier uw klacht toe") {
					$(this).val("");
				}

			});
		</script>
	</body>
</html>